# ТЗ: Telegram-бот для 360-градусного фидбэка

## 0. Цель

Автоматизировать сбор 360-фидбэка в Telegram: ≤ 5 параллельных циклов, фиксированная анкета (оценки 0–3 + открытые вопросы), хранение данных в Google Sheets, напоминания, ежедневная HR-сводка и итоговый отчёт.

---

## 1. Роли

| Роль           | Возможности                                                  |
| -------------- | ------------------------------------------------------------ |
| **HR-админ**   | `/new_cycle`, `/cancel`, `/status`; получает сводки и отчёты |
| **Респондент** | Заполняет назначенные анкеты                                 |
| **Бот**        | Реализует все функции ниже                                   |

---

## 2. Справочник сотрудников

* Google Sheets → таблица **`Employees`** (корпоративный аккаунт).
* Колонки (обязательные): `Telegram_Nickname`, `Last_Name`, `First_Name`.
    * `Telegram_Nickname` — ник в формате `@username`. Используется для **первичного сопоставления** пользователя с записью в таблице.
    * **Основным идентификатором** для отправки сообщений является **`telegram_id`** (числовой), который бот получает и сохраняет в Redis при первом контакте с пользователем. Это обеспечивает надежную доставку уведомлений.
    * Дополнительные поля (например, `Email`, `Position`) можно добавлять свободно — они игнорируются сервисом.

---

## 3. Cycle Management

| Шаг          | Детали                                                                                                    |
| ------------ | --------------------------------------------------------------------------------------------------------- |
| **Создание** | `/new_cycle` → HR выбирает `Target` (по нику), `Respondent_Nicks[]`, `Deadline`. Проверяется лимит ≤ 5 активных циклов. |
| **Cycle ID** | Формат `YYYYMMDD_<TelegramNick>` (напр. `20250622_@ivan`).                                           |
| **Отмена**   | `/cancel <Cycle_ID>` переводит цикл в `Closed` без отчёта.                                                |
| **Форс-финиш** | `/finish <Cycle_ID>` мгновенно переводит `Collecting → Closed` и запускает AI-отчёт. |

---

## 4. Анкета (фиксированная, структурированная для LLM)

| ID        | UI-тип     | Вопрос                                                | Шкала / варианты (`value → label`)                                       | Обязателен       | Колонка Sheets |
| --------- | ---------- | ----------------------------------------------------- | ------------------------------------------------------------------------ | ---------------- | -------------- |
| **G-1**   | `checkbox` | **Комфортно ли тебе работать с «{Имя}»?**             | `communication`, `flexibility`, `responsibility`, `openness`, `teamwork` | **да** (≥ 1 чек) | `G1_comfort`   |
| **G-1-c** | `textarea` | Дополнительный комментарий                            | —                                                                        | нет              | `G1_comment`   |
| **G-2**   | `radio`    | **Соответствует ли «{Имя}» своей экспертизе и роли?** | `yes`, `no`, `unknown`                                                   | **да**           | `G2_role_fit`  |

| **Компетенции (оценка 0–3)** |             |                                               |                                                                   |     |              |
| ---------------------------- | ----------- | --------------------------------------------- | ----------------------------------------------------------------- | --- | ------------ |
| **C-1**                      | `scale 0-3` | Ориентация на результат **\[Ownership]**      | 0 → «мин. результат» … 3 → «учитывает влияние на другие процессы» | да  | `C1_score`   |
| **C-1-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                         | —                                                                 | нет | `C1_comment` |
| **C-2**                      | `scale 0-3` | Ориентация на потребности клиента             | 0 → «не учитывает» … 3 → «предвосхищает»                          | да  | `C2_score`   |
| **C-2-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                            | —                                                                 | нет | `C2_comment` |
| **C-3**                      | `scale 0-3` | Ведение переговоров                           | 0 → «не достигает целей» … 3 → «win-win»                          | да  | `C3_score`   |
| **C-3-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                        | —                                                                 | нет | `C3_comment` |
| **C-4**                      | `scale 0-3` | Управление конфликтами                        | 0 → «неконструктив / избегает» … 3 → «конструктивно решает»       | да  | `C4_score`   |
| **C-4-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                         | —                                                                 | нет | `C4_comment` |
| **C-5**                      | `scale 0-3` | Определение приоритетов                       | 0 → «теряет фокус» … 3 → «правильно расставляет»                  | да  | `C5_score`   |
| **C-5-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                        | —                                                                 | нет | `C5_comment` |
| **C-6**                      | `scale 0-3` | Формирование эффективных команд               | 0 → «нет командности» … 3 → «формирует команды»                   | да  | `C6_score`   |
| **C-6-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                           | —                                                                 | нет | `C6_comment` |
| **C-7**                      | `scale 0-3` | Воспроизводство практики и развитие команды   | 0 → «тормозит развитие» … 3 → «помогает расти»                    | да  | `C7_score`   |
| **C-7-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                          | —                                                                 | нет | `C7_comment` |
| **C-8**                      | `scale 0-3` | Действия в неопределённости и решение проблем | 0 → «сопротивляется изменениям» … 3 → «инициирует решения»        | да  | `C8_score`   |
| **C-8-c**                    | `textarea`  | напиши пример по этой оценке или выбери «пропустить»                  | —                                                                 | нет | `C8_comment` |

| **Ключевые выводы и завершение** |            |                                      |   |        |                  |
| -------------------------------- | ---------- | ------------------------------------ | - | ------ | ---------------- |
| **O-1**                          | `textarea` | **Блокеры / несоответствия позиции** | — | **да** | `O1_blockers`    |
| **O-2**                          | `textarea` | **Сильные стороны**                  | — | **да** | `O2_strengths`   |
| **O-3**                          | `textarea` | Предложения и пожелания «{Имя}»      | — | нет    | `O3_suggestions` |

> **Шкала 0-3:** 0 — не проявляется · 1 — редко · 2 — норма · 3 — выдающийся.
> Бот блокирует «Отправить», если обязательные поля пусты или в **G-1** не выбран ни один чекбокс.

---

## 5. Процесс респондента

1. **Получение уведомления:**
   - Если `telegram_id` пользователя уже известен боту, он получает прямое сообщение с приглашением пройти опрос.
   - Если пользователь еще не взаимодействовал с ботом, уведомление ставится в очередь.
2. **Первый контакт:**
   - Пользователь должен сам инициировать диалог с ботом командой `/start`.
   - При первом запуске бот регистрирует его `telegram_id`, связывая его с `username` из Google Sheets, и немедленно доставляет все отложенные уведомления.
3. **Заполнение анкеты:**
   - Респондент заполняет анкету на робот.
   - Пока не нажал «Отправить», другая анкета не выдаётся.
4. **Завершение:**
   - После отправки ответа, если есть еще задания, бот предлагает пройти следующий опрос. Иначе — «Спасибо, все анкеты заполнены».
5. **Уведомление HR**  
   После каждого ответа респондента бот отправляет сообщение HR-админу:
   ```
   Цикл: {TargetNick}
   Заполнил: {RespondentNick} ✅
   Прогресс: 4 / 7 (57 %)
   Осталось: @petrov, @sidorov
   ```
   К уведомлению прикрепляется кнопка **🟢 Завершить сейчас**, позволяющая досрочно закрыть цикл (эквивалент `/finish <Cycle_ID>`).

---

## 6. Хранение данных

* **Один лист = один цикл**; имя `YYYY-MM-DD_TargetName`.
* Строка = JSON-ответ, колонки соответствуют полю **Колонка Sheets** из табл. 4 (`Cycle_ID`, `Respondent_ID`, `Submitted_at`, `G1_comfort`, …, `O3_suggestions`).
* **Append-only** — архив/удаление не требуются.

---

## 7. Таймеры (МСК)

| Событие        | Время / период         |
| -------------- | ---------------------- |
| HR-сводка      | 09:00 ежедневно        |
| Напоминание    | Каждые 3 дня           |
| Финальный пинг | За 2 дня до `Deadline` |
| Авто-закрытие  | 00:00 после Deadline или мгновенно после `/finish` |

---

## 8. HR-сводка (пример)

```text
Цикл: Иванова А.
Готово 4/7 (57 %), дедлайн через 5 дн
 • Иванов — ✅
 • Петров — ⏳
 ...
```

---

## 9. Отчёт (`Reported`)

1. **Markdown-сообщение**

   * средние 0–3 по 8 компетенциям (1 знак после запятой);
   * буллет «сильное / точка роста» для каждой;
   * общие сильные стороны / зоны роста (3–5 пунктов);
   * анонимные цитаты (фильтр: длина > 20 симв. → GPT-оценка информативности 0–10 → включаем > 6).
2. **CSV-ссылка** — прямой export листа Google Sheets.
3. Список «не заполнил» (отсутствует, если отчёт сформирован командой `/finish` до дедлайна).

---

## 10. Алгоритмы и ограничения

| Пункт                 | Значение                                        |
| --------------------- | ----------------------------------------------- |
| Параллельность циклов | ≤ 5                                             |
| Минимум N             | Нет, метрики считаем всегда                     |
| Ошибки Google API     | Логируем в stdout; без алертов/ретраев          |
| Права бота            | `spreadsheets.readonly` + `spreadsheets.append` |
| Язык                  | Весь UI и отчёты — **русский**                  |

---

## 11. Команды HR

```text
/new_cycle
/cancel <Cycle_ID>
/status
/finish <Cycle_ID>
/reload_questions
```

---